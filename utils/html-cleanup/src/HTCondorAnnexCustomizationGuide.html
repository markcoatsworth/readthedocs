<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>HTCondor Annex Customization Guide</title> 
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"> 
<meta name="generator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.tug.org/tex4ht/)"> 
<!-- 3,sec-filename,next,info,NoFonts,fonts,html --> 
<meta name="src" content="ref.tex"> 
<link rel="stylesheet" type="text/css" href="ref.css"> 
</head><body 
>
   <span style="font-size: 200%;"><a 
href="UsingCondorannexfortheFirstTime.html" >&#x21D0;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="UsingCondorannexfortheFirstTime.html#tailUsingCondorannexfortheFirstTime.html" >&#x2199;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="#tailHTCondorAnnexCustomizationGuide.html">&#x2193;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="CloudComputing.html#HTCondorAnnexCustomizationGuide.html" >&#x21D1;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="HTCondorAnnexConfiguration.html" >&#x21D2;</a></span>&nbsp;<a href="contentsname.html">Contents</a>&nbsp;<a href="indexname.html">Index</a><h3 class="sectionHead"><span class="titlemark">6.4   </span> <a 
 id="x66-5340006.4"></a>HTCondor Annex Customization Guide</h3>
   <div class="sectionTOCS">
   &#x00A0;&#x00A0;<span class="subsectionToc" >6.4.1 <a 
href="#x66-5350006.4.1">Amazon Web Services</a></span>
<br />   &#x00A0;&#x00A0;&#x00A0;<span class="subsubsectionToc" ><a 
href="#x66-5360006.4.1" id="QQ2-66-559">Resource Requests</a></span>
<br />   &#x00A0;&#x00A0;&#x00A0;<span class="subsubsectionToc" ><a 
href="#x66-5370006.4.1" id="QQ2-66-560">Secure Transport</a></span>
<br />   &#x00A0;&#x00A0;&#x00A0;<span class="subsubsectionToc" ><a 
href="#x66-5380006.4.1" id="QQ2-66-561">Image Requirements</a></span>
<br />   &#x00A0;&#x00A0;&#x00A0;<span class="subsubsectionToc" ><a 
href="#x66-5390006.4.1" id="QQ2-66-562">Instance Roles</a></span>
<br />   &#x00A0;&#x00A0;<span class="subsectionToc" >6.4.2 <a 
href="#x66-5400006.4.2">Azure</a></span>
<br />   &#x00A0;&#x00A0;<span class="subsectionToc" >6.4.3 <a 
href="#x66-5410006.4.3">Google Cloud Platform</a></span>
   </div>
<!--l. 3--><p class="indent" >   Aside from the configuration macros (see section <a 
href="HTCondorAnnexConfiguration.html#x67-5420006.5">6.5<!--tex4ht:ref: sec:clouds-config --></a>, below), the major way to customize <span class="textit">condor_annex</span> is my
customizing the default disk image. Because the implementation of <span class="textit">condor_annex</span> varies from service to service,
and that implementation determines the constraints on the disk image, the this section is divided by
service.
<!--l. 1--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">6.4.1   </span> <a 
 id="x66-5350006.4.1"></a>Amazon Web Services</h4>
<!--l. 3--><p class="noindent" >Requirements for an Annex-compatible AMI are driven by how <span class="textit">condor_annex</span> securely transports HTCondor
configuration and security tokens to the instances; we will discuss that implementation briefly, to help you
understand the requirements, even though it will hopefully never matter to you.
<!--l. 9--><p class="noindent" >
   <h5 class="subsubsectionHead"><a 
 id="x66-5360006.4.1"></a>Resource Requests</h5>
                                                                                         

                                                                                         
<!--l. 11--><p class="noindent" >For on-demand or Spot instances, we begin by making a single resource request whose client token is the annex
name concatenated with an underscore and then a newly-generated GUID. This construction allows us to terminate
on-demand instances belonging to a particular annex (by its name), as well as discover the annex name from inside
an instance.
<!--l. 17--><p class="indent" >   An on-demand instance may obtain its instance ID directly from the AWS metadata server, and then ask
another AWS API for that instance ID&#8217;s client token. Since GUIDs do not contain underscores, we can be certain
that anything to the left of the last underscore is the annex&#8217;s name.
<!--l. 22--><p class="indent" >   An instance started by a Spot Fleet has a client token generated by the Spot Fleet. Instead of performing a
direct lookup, a Spot Fleet instance must therefore determine which Spot Fleet started it, and then obtain that Spot
Fleet&#8217;s client token. A Spot Fleet will tag an instance with the Spot Fleet&#8217;s identity after the instance starts up.
This usually only takes a few minutes, but the default image waits for up to 50 minutes, since you&#8217;re already paying
for the first hour anyway.
<!--l. 30--><p class="noindent" >
   <h5 class="subsubsectionHead"><a 
 id="x66-5370006.4.1"></a>Secure Transport</h5>
<!--l. 32--><p class="noindent" >At this point, the instance knows its annex&#8217;s name. This allows the instance to construct the name of the tarball it
should download (config-AnnexName.tar.gz), but does not tell it from where a file with that name should be
downloaded.
<!--l. 37--><p class="indent" >   (Because the user data associated with resource request is not secure, and because we want to leave the
user data available for its normal usage, we can&#8217;t just encode the tarball or its location in the user
data.)
<!--l. 41--><p class="indent" >   The instance determines from which S3 bucket to download by asking the metadata server which role the
instance is playing. (An instance without a role is unable to make use of any AWS services without acquiring
valid AWS tokens through some other method.) The instance role created by the setup procedure
includes permission to read files matching the pattern config-*.tar.gz from a particular private S3
bucket. If the instance finds permissions matching that pattern, it assumes that the corresponding
S3 bucket is the one from which it should download, and does so; if successful, it untars the file in
/etc/condor/config.d.
<!--l. 51--><p class="indent" >   In v8.7.1, the script executing these steps is named 49ec2-instance.sh, and is called during configuration when
HTCondor first starts up.
<!--l. 54--><p class="indent" >   In v8.7.2, the script executing these steps is named condor-annex-ec2, and is called during system
start-up.
<!--l. 57--><p class="indent" >   The HTCondor configuration and security tokens are at this point protected on the instance&#8217;s disk by
the usual filesystem permissions. To prevent HTCondor jobs from using the instance&#8217;s permissions
to do anything, but in particular download their own copy of the security tokens, the last thing the
script does is use the Linux kernel firewall to forbid any non-root process from accessing the metadata
server.
                                                                                         

                                                                                         
<!--l. 64--><p class="noindent" >
   <h5 class="subsubsectionHead"><a 
 id="x66-5380006.4.1"></a>Image Requirements</h5>
<!--l. 66--><p class="noindent" >Thus, to work with <span class="textit">condor_annex</span>, an AWS AMI must:
     <ul class="itemize1">
     <li class="itemize">Fetch the HTCondor configuration and security tokens from S3;
     </li>
     <li class="itemize">configure HTCondor to turn off after it&#8217;s been idle for too long;
     </li>
     <li class="itemize">and turn off the instance when the HTCondor master daemon exits.</li></ul>
<!--l. 74--><p class="indent" >   The second item could be construed as optional, but if left unimplemented, will disable the <span class="textbf">-idle</span> command-line
option.
<!--l. 77--><p class="indent" >   The default disk image implements the above as follows:
     <ul class="itemize1">
     <li class="itemize">with a configuration script (/etc/condor/49ec2-instance.sh);
     </li>
     <li class="itemize">with a single configuration item (<span class="texttt">STARTD_NOCLAIM_SHUTDOWN</span> <a 
 id="dx66-538001"></a><a 
 id="dx66-538002"></a>);
     </li>
     <li class="itemize">with  a  configuration  item  (<span class="texttt">DEFAULT_MASTER_SHUTDOWN_SCRIPT</span> <a 
 id="dx66-538003"></a><a 
 id="dx66-538004"></a>)  and  the  corresponding  script
     (/etc/condor/master_shutdown.sh), which just turns around and runs shutdown -h now.</li></ul>
<!--l. 87--><p class="indent" >   We also strongly recommend that every <span class="textit">condor_annex</span> disk image:
     <ul class="itemize1">
     <li class="itemize">Advertise, in the master and startd, the instance ID.
     </li>
     <li class="itemize">Use the instance&#8217;s public IP, by setting <span class="texttt">TCP_FORWARDING_HOST</span> <a 
 id="dx66-538005"></a><a 
 id="dx66-538006"></a>.
     </li>
     <li class="itemize">Turn on communications integrity and encryption.
                                                                                         

                                                                                         
     </li>
     <li class="itemize">Encrypt the run directories.
     </li>
     <li class="itemize">Restrict access to the EC2 meta-data server to root.</li></ul>
<!--l. 97--><p class="indent" >   The default disk image is configured to do all of this.
<!--l. 99--><p class="noindent" >
   <h5 class="subsubsectionHead"><a 
 id="x66-5390006.4.1"></a>Instance Roles</h5>
<!--l. 102--><p class="noindent" >To explain the last point immediately above, EC2 stores (temporary) credentials for the role, if any, associated with
an instance on that instance&#8217;s meta-data server, which may be accessed via HTTP at a well- known address
(currently 169.254.169.254). Unless otherwise configured, any process in the instance can access the meta-data server
and thereby make use of the instance&#8217;s credentials.
<!--l. 109--><p class="indent" >   Until version 8.9.0, there was no HTCondor-based reason to run an EC2 instance with an instance role. Starting
in 8.9.0, however, HTCondor gained the ability to use the instance role&#8217;s credentials to run EC2 universe jobs and
<span class="textit">condor_annex</span> commands. This has several advantages over copying credentials into the instance: it may be more
convenient, and if you&#8217;re the only user of the instance, it&#8217;s more secure, because the instance&#8217;s credentials expire
when the instance does.
<!--l. 117--><p class="indent" >   However, wanting to allow (other) users to run jobs on or submit jobs to your instance may not
mean you want them to able to act with the instance&#8217;s privileges (e.g., starting more instances on your
account). Although securing your instances ultimately remains your responsibility, the default images we
provide for <span class="textit">condor_annex</span>, and the condor-annex-ec2 package, both use the kernel-level firewall to
prevent access to the metadata server by any process not owned by root. Because this firewall rule is
added during the boot sequence, it will be in place before HTCondor can start any user jobs, and
should therefore be effective in preventing access to the instance&#8217;s credentials by normal users or their
jobs.
<!--l. 1--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">6.4.2   </span> <a 
 id="x66-5400006.4.2"></a>Azure</h4>
<!--l. 3--><p class="noindent" >Not implemented as of v8.7.8.
<!--l. 1--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">6.4.3   </span> <a 
 id="x66-5410006.4.3"></a>Google Cloud Platform</h4>
                                                                                         

                                                                                         
<!--l. 3--><p class="noindent" >Not implemented as of v8.7.8.
                                                                                         

                                                                                         
<!--l. 1--><p class="indent" >   <span style="font-size: 200%;"><a 
href="UsingCondorannexfortheFirstTime.html" >&#x21D0;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="UsingCondorannexfortheFirstTime.html#tailUsingCondorannexfortheFirstTime.html" >&#x2199;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="HTCondorAnnexCustomizationGuide.html" >&#x2191;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="CloudComputing.html#HTCondorAnnexCustomizationGuide.html" >&#x21D1;</a></span>&nbsp;<span style="font-size: 200%;"><a 
href="HTCondorAnnexConfiguration.html" >&#x21D2;</a></span>&nbsp;<a href="contentsname.html">Contents</a>&nbsp;<a href="indexname.html">Index</a><a 
 id="tailHTCondorAnnexCustomizationGuide.html"></a>  
</body></html> 
